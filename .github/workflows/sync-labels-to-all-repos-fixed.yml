name: åŒæ­¥æ¨™ç±¤åˆ°æ‰€æœ‰çµ„ç¹”å„²å­˜åº«

on:
  push:
    branches: [ main ]
    paths: [ '.github/labels.yml' ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'åŸ·è¡Œé è¦½æ¨¡å¼ï¼ˆä¸å¯¦éš›å¥—ç”¨è®Šæ›´ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  get-repos:
    runs-on: ubuntu-latest
    name: ç²å–çµ„ç¹”å„²å­˜åº«æ¸…å–®
    outputs:
      repositories: ${{ steps.get-repos.outputs.repositories }}
    
    steps:
    - name: ç²å–çµ„ç¹”å…§æ‰€æœ‰å„²å­˜åº«
      id: get-repos
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰ ORG_PAT_TOKEN
        if [ -z "${{ secrets.ORG_PAT_TOKEN }}" ]; then
          echo "âŒ éŒ¯èª¤: éœ€è¦è¨­å®š ORG_PAT_TOKEN secret æ‰èƒ½å­˜å–çµ„ç¹”å…§çš„å…¶ä»–å„²å­˜åº«"
          echo "è«‹åˆ°å„²å­˜åº«è¨­å®š > Secrets and variables > Actions ä¸­æ–°å¢ž ORG_PAT_TOKEN"
          echo "Token éœ€è¦ä»¥ä¸‹æ¬Šé™: repo, read:org"
          exit 1
        fi
        
        # ä½¿ç”¨ GitHub API ç²å–çµ„ç¹”å…§æ‰€æœ‰å„²å­˜åº«ï¼ˆæŽ’é™¤ fork å’Œ archivedï¼‰
        echo "ðŸ” æ­£åœ¨ç²å–çµ„ç¹” ${{ github.repository_owner }} çš„å„²å­˜åº«æ¸…å–®..."
        
        REPOS=$(curl -s \
          -H "Authorization: Bearer ${{ secrets.ORG_PAT_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/orgs/${{ github.repository_owner }}/repos?per_page=100&type=all" \
          | jq -r '.[] | select(.fork == false and .archived == false) | .name' \
          | jq -R -s -c 'split("\n")[:-1]')
        
        if [ "$REPOS" = "[]" ] || [ -z "$REPOS" ]; then
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å„²å­˜åº«æˆ– API å‘¼å«å¤±æ•—"
          echo "è«‹æª¢æŸ¥ ORG_PAT_TOKEN çš„æ¬Šé™"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°çš„å„²å­˜åº«: $REPOS"
        echo "repositories=$REPOS" >> $GITHUB_OUTPUT

  sync-labels:
    needs: get-repos
    runs-on: ubuntu-latest
    name: åŒæ­¥æ¨™ç±¤
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        repository: ${{ fromJson(needs.get-repos.outputs.repositories) }}
    
    steps:
    - name: æª¢å‡ºæ¨™ç±¤é…ç½®æª”æ¡ˆ
      uses: actions/checkout@v4
      with:
        sparse-checkout: .github/labels.yml
        
    - name: ä½¿ç”¨ GitHub API åŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }}
      run: |
        echo "ðŸ”„ é–‹å§‹åŒæ­¥æ¨™ç±¤åˆ° ${{ github.repository_owner }}/${{ matrix.repository }}"
        
        # è®€å–æ¨™ç±¤é…ç½®
        LABELS=$(yq eval -o=json '.[]' .github/labels.yml | jq -s '.')
        
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ðŸ” é è¦½æ¨¡å¼ï¼šå°‡è¦åŒæ­¥çš„æ¨™ç±¤ï¼š"
          echo "$LABELS" | jq -r '.[] | "- \(.name): \(.color) (\(.description // "ç„¡æè¿°"))"'
          exit 0
        fi
        
        # åŒæ­¥æ¯å€‹æ¨™ç±¤
        echo "$LABELS" | jq -c '.[]' | while read -r label; do
          name=$(echo "$label" | jq -r '.name')
          color=$(echo "$label" | jq -r '.color')
          description=$(echo "$label" | jq -r '.description // ""')
          
          echo "ðŸ“Œ è™•ç†æ¨™ç±¤: $name"
          
          # æª¢æŸ¥æ¨™ç±¤æ˜¯å¦å·²å­˜åœ¨
          existing_label=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.ORG_PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository_owner }}/${{ matrix.repository }}/labels/$(echo "$name" | jq -r @uri)" \
            | jq -r '.name // empty' 2>/dev/null)
          
          if [ -n "$existing_label" ]; then
            # æ›´æ–°ç¾æœ‰æ¨™ç±¤
            echo "  â†» æ›´æ–°ç¾æœ‰æ¨™ç±¤"
            curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.ORG_PAT_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository_owner }}/${{ matrix.repository }}/labels/$(echo "$name" | jq -r @uri)" \
              -d "{\"name\":\"$name\",\"color\":\"$color\",\"description\":\"$description\"}" > /dev/null
          else
            # å‰µå»ºæ–°æ¨™ç±¤
            echo "  âœ¨ å‰µå»ºæ–°æ¨™ç±¤"
            curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.ORG_PAT_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository_owner }}/${{ matrix.repository }}/labels" \
              -d "{\"name\":\"$name\",\"color\":\"$color\",\"description\":\"$description\"}" > /dev/null
          fi
        done
        
        echo "âœ… å®ŒæˆåŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }}"
        
      continue-on-error: true
      
    - name: è¨˜éŒ„åŒæ­¥çµæžœ
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… æˆåŠŸåŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }}"
        else
          echo "âŒ åŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }} å¤±æ•—"
        fi

  summary:
    needs: [get-repos, sync-labels]
    runs-on: ubuntu-latest
    name: åŒæ­¥æ‘˜è¦
    if: always()
    
    steps:
    - name: è¼¸å‡ºåŒæ­¥æ‘˜è¦
      run: |
        echo "## ðŸ·ï¸ æ¨™ç±¤åŒæ­¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¸ç™¼åŽŸå› **: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ¨™å„²å­˜åº«æ•¸é‡**: $(echo '${{ needs.get-repos.outputs.repositories }}' | jq length)" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ¨¡å¼**: ${{ github.event.inputs.dry_run == 'true' && 'ðŸ” é è¦½æ¨¡å¼' || 'ðŸš€ å¯¦éš›åŸ·è¡Œ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **çµ„ç¹”**: ${{ github.repository_owner }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ ç›®æ¨™å„²å­˜åº«æ¸…å–®:" >> $GITHUB_STEP_SUMMARY
        echo '${{ needs.get-repos.outputs.repositories }}' | jq -r '.[]' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ è¨­å®šèªªæ˜Ž:" >> $GITHUB_STEP_SUMMARY
        echo "å¦‚æžœåŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèª:" >> $GITHUB_STEP_SUMMARY
        echo "1. å·²è¨­å®š \`ORG_PAT_TOKEN\` secret" >> $GITHUB_STEP_SUMMARY
        echo "2. Token å…·æœ‰ \`repo\` å’Œ \`read:org\` æ¬Šé™" >> $GITHUB_STEP_SUMMARY
        echo "3. Token çš„æ“æœ‰è€…å°ç›®æ¨™å„²å­˜åº«æœ‰å¯«å…¥æ¬Šé™" >> $GITHUB_STEP_SUMMARY
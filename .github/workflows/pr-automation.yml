name: ğŸ¤– Pull Request è‡ªå‹•åŒ–è™•ç†

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  pr-labeler:
    name: ğŸ·ï¸ PR è‡ªå‹•æ¨™ç±¤
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: ğŸ·ï¸ æ ¹æ“š PR å…§å®¹è‡ªå‹•æ·»åŠ æ¨™ç±¤
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();
            const body = pr.body ? pr.body.toLowerCase() : '';
            
            let labels = [];
            
            // æ ¹æ“šæ¨™é¡Œå’Œå…§å®¹æ·»åŠ æ¨™ç±¤
            if (title.includes('ğŸ›') || title.includes('bug') || title.includes('fix')) {
              labels.push('bug');
            }
            if (title.includes('âœ¨') || title.includes('feat') || title.includes('feature')) {
              labels.push('enhancement');
            }
            if (title.includes('ğŸ“š') || title.includes('docs') || title.includes('documentation')) {
              labels.push('documentation');
            }
            if (title.includes('ğŸ”’') || title.includes('security') || body.includes('security')) {
              labels.push('security');
            }
            if (title.includes('ğŸ“ˆ') || title.includes('performance') || body.includes('performance')) {
              labels.push('performance');
            }
            if (title.includes('ğŸ§ª') || title.includes('test') || body.includes('test')) {
              labels.push('test');
            }
            if (title.includes('ğŸ¨') || title.includes('style') || body.includes('style')) {
              labels.push('style');
            }
            if (title.includes('ğŸ”§') || title.includes('refactor') || body.includes('refactor')) {
              labels.push('refactor');
            }
            
            // æ ¹æ“šæª”æ¡ˆè®Šæ›´æ·»åŠ æŠ€è¡“æ¨™ç±¤
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const changedFiles = files.data.map(file => file.filename.toLowerCase());
            
            if (changedFiles.some(file => file.includes('.cs') || file.includes('.csproj'))) {
              labels.push('dotnet');
            }
            if (changedFiles.some(file => file.includes('.js') || file.includes('.ts') || file.includes('.jsx') || file.includes('.tsx'))) {
              labels.push('frontend');
            }
            if (changedFiles.some(file => file.includes('.sql') || file.includes('migration'))) {
              labels.push('database');
            }
            if (changedFiles.some(file => file.includes('.yml') || file.includes('.yaml') || file.includes('dockerfile'))) {
              labels.push('devops');
            }
            if (changedFiles.some(file => file.includes('.md') || file.includes('readme'))) {
              labels.push('documentation');
            }
            
            // æ ¹æ“šè®Šæ›´å¤§å°æ·»åŠ æ¨™ç±¤
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;
            
            if (totalChanges < 10) {
              labels.push('size/XS');
            } else if (totalChanges < 30) {
              labels.push('size/S');
            } else if (totalChanges < 100) {
              labels.push('size/M');
            } else if (totalChanges < 500) {
              labels.push('size/L');
            } else {
              labels.push('size/XL');
            }
            
            // å»é‡
            labels = [...new Set(labels)];
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
              
              console.log(`å·²ç‚º PR #${pr.number} æ·»åŠ æ¨™ç±¤: ${labels.join(', ')}`);
            }
            
  pr-size-checker:
    name: ğŸ“ PR å¤§å°æª¢æŸ¥
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
      - name: ğŸ“ æª¢æŸ¥ PR å¤§å°ä¸¦æ·»åŠ è©•è«–
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;
            
            let sizeComment = '';
            let reviewSuggestion = '';
            
            if (totalChanges > 500) {
              sizeComment = `## ğŸ“Š PR å¤§å°åˆ†æ\n\né€™å€‹ PR åŒ…å« **${totalChanges}** è¡Œè®Šæ›´ï¼ˆ+${additions}/-${deletions}ï¼‰ï¼Œå±¬æ–¼å¤§å‹ PRã€‚\n\n`;
              reviewSuggestion = `### ğŸ” å¯©æŸ¥å»ºè­°\n- è€ƒæ…®å°‡å¤§å‹ PR æ‹†åˆ†æˆå¤šå€‹è¼ƒå°çš„ PR\n- å¢åŠ æ›´è©³ç´°çš„èªªæ˜å’Œæ¸¬è©¦\n- å¯èƒ½éœ€è¦é¡å¤–çš„å¯©æŸ¥æ™‚é–“\n\n`;
            } else if (totalChanges > 100) {
              sizeComment = `## ğŸ“Š PR å¤§å°åˆ†æ\n\né€™å€‹ PR åŒ…å« **${totalChanges}** è¡Œè®Šæ›´ï¼ˆ+${additions}/-${deletions}ï¼‰ï¼Œå±¬æ–¼ä¸­å‹ PRã€‚\n\n`;
              reviewSuggestion = `### ğŸ” å¯©æŸ¥å»ºè­°\n- ç¢ºä¿æ¸¬è©¦è¦†è“‹å……è¶³\n- æª¢æŸ¥æ˜¯å¦éœ€è¦æ–‡æª”æ›´æ–°\n\n`;
            } else {
              sizeComment = `## ğŸ“Š PR å¤§å°åˆ†æ\n\né€™å€‹ PR åŒ…å« **${totalChanges}** è¡Œè®Šæ›´ï¼ˆ+${additions}/-${deletions}ï¼‰ï¼Œå¤§å°é©ä¸­ï¼Œä¾¿æ–¼å¯©æŸ¥ã€‚\n\n`;
            }
            
            const comment = sizeComment + reviewSuggestion + `---\nğŸ¤– æ­¤è©•è«–ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ`;
            
            // åªç‚ºæ–° PR æˆ–è®Šæ›´è¼ƒå¤§çš„ PR æ·»åŠ è©•è«–
            if (context.payload.action === 'opened' && totalChanges > 50) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }
            
  pr-checklist:
    name: âœ… PR æª¢æŸ¥æ¸…å–®é©—è­‰
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
      - name: âœ… é©—è­‰ PR æª¢æŸ¥æ¸…å–®å®Œæˆåº¦
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // è¨ˆç®—å‹¾é¸çš„æª¢æŸ¥é …ç›®
            const checkboxes = body.match(/- \[[x ]\]/g) || [];
            const checkedBoxes = body.match(/- \[x\]/gi) || [];
            
            if (checkboxes.length > 0) {
              const completionRate = (checkedBoxes.length / checkboxes.length * 100).toFixed(1);
              
              const statusComment = `## âœ… PR æª¢æŸ¥æ¸…å–®ç‹€æ…‹\n\n` +
                `**å®Œæˆåº¦**: ${checkedBoxes.length}/${checkboxes.length} (${completionRate}%)\n\n` +
                `${'â–“'.repeat(Math.floor(completionRate / 10))}${'â–‘'.repeat(10 - Math.floor(completionRate / 10))} ${completionRate}%\n\n`;
              
              let reminder = '';
              if (completionRate < 80) {
                reminder = `### ğŸš¨ æé†’\nè«‹å®Œæˆ PR æ¨¡æ¿ä¸­çš„æª¢æŸ¥æ¸…å–®é …ç›®ï¼Œä»¥ç¢ºä¿ç¨‹å¼ç¢¼å“è³ªå’ŒåŠ å¿«å¯©æŸ¥æµç¨‹ã€‚\n\n`;
              } else if (completionRate === 100) {
                reminder = `### ğŸ‰ å¤ªæ£’äº†ï¼\næ‰€æœ‰æª¢æŸ¥æ¸…å–®é …ç›®éƒ½å·²å®Œæˆï¼ŒPR å·²æº–å‚™å¥½é€²è¡Œå¯©æŸ¥ï¼\n\n`;
              }
              
              const comment = statusComment + reminder + `---\nğŸ¤– æ­¤è©•è«–ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ`;
              
              // ç‚ºæª¢æŸ¥æ¸…å–®å®Œæˆåº¦è¼ƒä½çš„ PR æ·»åŠ æé†’
              if (context.payload.action === 'opened' && completionRate < 80) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
              }
            }
name: åŒæ­¥æ¨™ç±¤åˆ°æ‰€æœ‰çµ„ç¹”å„²å­˜åº«

on:
  push:
    branches: [ main ]
    paths: [ '.github/labels.yml' ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'åŸ·è¡Œé è¦½æ¨¡å¼ï¼ˆä¸å¯¦éš›å¥—ç”¨è®Šæ›´ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  get-repos:
    runs-on: ubuntu-latest
    name: ç²å–çµ„ç¹”å„²å­˜åº«æ¸…å–®
    outputs:
      repositories: ${{ steps.get-repos.outputs.repositories }}
    
    steps:
    - name: ç²å–çµ„ç¹”å…§æ‰€æœ‰å„²å­˜åº«
      id: get-repos
      run: |
        # ä½¿ç”¨ GitHub API ç²å–çµ„ç¹”å…§æ‰€æœ‰å„²å­˜åº«ï¼ˆæŽ’é™¤ fork å’Œ archivedï¼‰
        REPOS=$(curl -s \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/orgs/${{ github.repository_owner }}/repos?per_page=100&type=all" \
          | jq -r '.[] | select(.fork == false and .archived == false) | .name' \
          | jq -R -s -c 'split("\n")[:-1]')
        
        echo "æ‰¾åˆ°çš„å„²å­˜åº«: $REPOS"
        echo "repositories=$REPOS" >> $GITHUB_OUTPUT

  sync-labels:
    needs: get-repos
    runs-on: ubuntu-latest
    name: åŒæ­¥æ¨™ç±¤
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        repository: ${{ fromJson(needs.get-repos.outputs.repositories) }}
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: åŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }}
      uses: EndBug/label-sync@v2
      with:
        config-file: .github/labels.yml
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository_owner }}/${{ matrix.repository }}
        delete-other-labels: false
        dry-run: ${{ github.event.inputs.dry_run == 'true' }}
      continue-on-error: true
      
    - name: è¨˜éŒ„åŒæ­¥çµæžœ
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… æˆåŠŸåŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }}"
        else
          echo "âŒ åŒæ­¥æ¨™ç±¤åˆ° ${{ matrix.repository }} å¤±æ•—"
        fi

  summary:
    needs: [get-repos, sync-labels]
    runs-on: ubuntu-latest
    name: åŒæ­¥æ‘˜è¦
    if: always()
    
    steps:
    - name: è¼¸å‡ºåŒæ­¥æ‘˜è¦
      run: |
        echo "## æ¨™ç±¤åŒæ­¥æ‘˜è¦ ðŸ“‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¸ç™¼åŽŸå› **: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ¨™å„²å­˜åº«æ•¸é‡**: $(echo '${{ needs.get-repos.outputs.repositories }}' | jq length)" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ¨¡å¼**: ${{ github.event.inputs.dry_run == 'true' && 'é è¦½æ¨¡å¼' || 'å¯¦éš›åŸ·è¡Œ' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å„²å­˜åº«æ¸…å–®:" >> $GITHUB_STEP_SUMMARY
        echo '${{ needs.get-repos.outputs.repositories }}' | jq -r '.[]' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
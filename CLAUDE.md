# CLAUDE.md

此檔案為 Claude Code (claude.ai/code) 在此儲存庫中工作時的指引文件。

## 儲存庫目的

這是環友科技股份有限公司 (UTK Technology Co., Ltd.) 的 GitHub 組織預設儲存庫 (`.github`)。包含組織層級的範本、政策和自動化功能，會自動套用至 UTK-TW 組織中的所有儲存庫。

## 主要架構

### 組織結構
- **組織檔案**: `/profile/README.md` 作為 github.com/UTK-TW 的公開組織頁面
- **範本**: `.github/ISSUE_TEMPLATE/` 包含標準化問題表單，涵蓋錯誤回報、功能請求、問題諮詢和文件需求
- **工作流程**: `.github/workflows/` 包含 GitHub Actions，用於在所有組織儲存庫間自動同步標籤
- **標準**: `.github/labels.yml` 定義所有 UTK 專案使用的標準標籤系統

### 技術堆疊環境
組織主要使用：
- .NET 8.0 / .NET Core 與 ASP.NET Core MVC/API
- Entity Framework Core 進行資料存取
- Azure 雲端服務和 Azure SQL
- Windows Server/IIS 部署
- 工作排程器進行自動化

## 常用指令

### 標籤管理
```bash
# 觸發跨所有組織儲存庫的標籤同步
# 透過 GitHub UI: Actions 頁籤 > "同步標籤到所有組織儲存庫" > Run workflow

# 預覽模式 (試執行):
gh workflow run sync-labels-to-all-repos-fixed.yml --field dry_run=true

# 強制同步而不修改 labels.yml:
gh workflow run sync-labels-to-all-repos-fixed.yml
```

### 驗證與測試
```bash
# 驗證工作流程和設定檔的 YAML 語法
yamllint .github/workflows/
yamllint .github/labels.yml

# 檢查工作流程語法
gh workflow list
gh workflow view sync-labels-to-all-repos-fixed.yml
```

## 重要檔案及其影響

### 自動套用檔案
這些檔案會自動套用至 UTK-TW 組織中所有沒有自訂版本的儲存庫：
- `CONTRIBUTING.md` - 開發和貢獻標準
- `SECURITY.md` - 安全政策和漏洞回報
- `SUPPORT.md` - 技術支援流程和聯絡資訊
- `LICENSE` - 專有授權條款
- `.github/ISSUE_TEMPLATE/` 中的問題範本

### 工作流程相依性
- **標籤同步工作流程**: 需要具有 `repo` 和 `read:org` 權限的 `ORG_PAT_TOKEN` 密鑰
- **目標儲存庫**: 自動發現組織中所有非分支、非封存的儲存庫
- **並行執行**: 同時處理最多 3 個儲存庫以避免 API 速率限制

## 語言與在地化

所有文件主要使用繁體中文，針對台灣/香港市場。進行修改時請：
- 保持中文作為主要語言
- 使用適合台灣科技業的商業術語
- 遵循既有的正式語調和結構
- 考量繁體中文字符的使用

## 安全與合規

### 權杖管理
- `ORG_PAT_TOKEN` 必須保持安全並定期輪換
- 工作流程在執行前會驗證權杖權限
- 驗證失敗會停止執行並提供明確錯誤訊息

### 文件標準
- 安全政策包含完整的 OWASP 合規指導原則
- 所有程式碼範例都展示安全編碼實踐（參數化查詢、輸入驗證、HTTPS 強制執行）
- 漏洞揭露程序遵循業界最佳實踐

## 工作流程行為

### 標籤同步
主要自動化功能會將 `.github/labels.yml` 的標籤同步至所有組織儲存庫：
- **觸發條件**: 推送到主分支影響 `labels.yml` 或手動觸發工作流程
- **範圍**: 所有活動中的（非分支、非封存）組織儲存庫
- **安全機制**: 包含試執行模式和完整錯誤處理
- **衝突解決**: 更新既有標籤，建立缺失標籤

修改 labels.yml 時：
1. 變更會自動觸發同步
2. 工作流程提供詳細操作摘要
3. 個別儲存庫失敗不會停止整個程序
4. 結果會記錄每個儲存庫的成功/失敗狀態

## Claude Code 開發指引

> Think carefully and implement the most concise solution that changes as little code as possible.

### 子代理程式使用策略

#### 1. 檔案分析：使用 file-analyzer 子代理程式
當需要讀取檔案時，應使用 file-analyzer 代理程式。此代理程式專門提取和總結檔案中的關鍵資訊，特別是日誌檔案和詳細輸出，提供簡潔、可行的摘要，在大幅減少上下文使用的同時保留必要資訊。

#### 2. 程式碼分析：使用 code-analyzer 子代理程式
當需要搜索程式碼、分析程式碼、研究錯誤或追蹤邏輯流程時，應使用 code-analyzer 代理程式。此代理程式專精於程式碼分析、邏輯追蹤和漏洞檢測。

#### 3. 測試執行：使用 test-runner 子代理程式
當需要執行測試和分析測試結果時，應使用 test-runner 代理程式，確保：
- 完整捕獲測試輸出用於除錯
- 保持主要對話的清潔和專注
- 優化上下文使用量
- 適當地浮現所有問題
- 避免批准對話框中斷工作流程

### 開發哲學

#### 錯誤處理原則
- **快速失敗**：對關鍵設定（缺少文字模型）採取快速失敗策略
- **記錄並繼續**：對可選功能（提取模型）記錄錯誤並繼續執行
- **優雅降級**：當外部服務不可用時優雅降級
- **使用者友善訊息**：透過復原層提供使用者友善的錯誤訊息

#### 測試原則
- 始終使用 test-runner 代理程式執行測試
- 永遠不要使用模擬服務
- 在完成當前測試之前不要進行下一個測試
- 如果測試失敗，先檢查測試結構是否正確，再決定是否需要重構程式庫
- 測試應該詳細，以便用於除錯

### 溝通風格與行為準則

- 歡迎批評：當發現錯誤或可能的錯誤時，請直接指出
- 建議更好的方法：如果有更好的做法，請提出建議
- 告知相關標準：如果存在相關標準或慣例，請告知
- 保持懷疑態度
- 保持簡潔
- 簡短摘要可以接受，但除非討論計畫細節，否則不要過度展開
- 不要諂媚或恭維，除非特別要求判斷
- 偶爾的客套話可以接受
- 多提問題：如果對意圖有疑問，請詢問而不是猜測

### 絕對規則

- **禁止部分實作**：不允許未完成的實作
- **禁止簡化**：不允許「現在簡化處理，完整實作會...」的做法
- **禁止程式碼重複**：檢查現有程式庫以重用功能和常數，在寫新功能前先讀取檔案，使用常識性的功能名稱以便找到
- **禁止死程式碼**：要麼使用，要麼從程式庫中完全刪除
- **為每個功能實作測試**：所有功能都必須有對應的測試
- **禁止欺騙性測試**：測試必須準確反映真實使用情況，設計用來發現缺陷。測試應該詳細以便用於除錯
- **禁止不一致的命名**：閱讀現有程式庫的命名模式
- **禁止過度工程**：當簡單功能就能運作時，不要加入不必要的抽象、工廠模式或中介軟體
- **禁止關注點混合**：不要將驗證邏輯放在 API 處理器中，不要將資料庫查詢放在 UI 元件中
- **禁止資源洩漏**：記得關閉資料庫連線、清除逾時、移除事件監聽器或清理檔案控制代碼